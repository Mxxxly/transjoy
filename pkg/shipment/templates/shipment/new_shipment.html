{% extends "user/dashboard.html" %}
    {% block content %}
    <div class="container-fluid bg-dark">
    </div>
<div class="container-fluid p-0">
    </div>
<div class="container-fluid py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 text-primary text-center">
                    <i class="fa fa-box-open mr-2"></i> Create New Shipment
                </h1>
                <p class="lead text-muted text-center">Enter the details for your package and destination.</p>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow border-0">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Shipment Details</h4>
                    </div>
                    <div class="card-body">
                        
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }} text-center">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form method="POST" action="{{ url_for('bpshipment.new_shipment') }}" id="shipmentForm">
                            {{ form.hidden_tag() }}
                
                            <div class="mb-5">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 32px; height: 32px;">
                                        <i class="fa fa-user fa-sm"></i>
                                    </div>
                                    <h5 class="text-dark font-weight-bold mb-0">Receiver Information</h5>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small font-weight-bold uppercase mb-1">{{ form.receiver_name.label.text }}</label>
                                        {{ form.receiver_name(class="form-control form-control-lg border-light shadow-sm", style="background-color: #f8f9fa;", placeholder="Enter full name") }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small font-weight-bold uppercase mb-1">{{ form.receiver_phone.label.text }}</label>
                                        {{ form.receiver_phone(class="form-control form-control-lg border-light shadow-sm", style="background-color: #f8f9fa;", placeholder="+234...") }}
                                    </div>
                                </div>
                            </div>
                
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <div class="p-3 rounded-lg h-100" style="border: 1px solid #e9ecef;">
                                        <h6 class="text-primary font-weight-bold mb-3"><i class="fa fa-map-marker-alt mr-2"></i>Pickup Location</h6>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.pickup_state.label.text }}</label>
                                                {{ form.pickup_state(class="form-control shadow-none", id="pickup_state") }}
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.pickup_city.label.text }}</label>
                                                {{ form.pickup_city(class="form-control shadow-none", id="pickup_city") }}
                                            </div>
                                            <div class="col-12">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.pickup_address.label.text }}</label>
                                                {{ form.pickup_address(class="form-control shadow-none", rows="2", placeholder="Street address...") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                
                                <div class="col-lg-6 mb-4">
                                    <div class="p-3 rounded-lg h-100" style="border: 1px solid #e9ecef;">
                                        <h6 class="text-success font-weight-bold mb-3"><i class="fa fa-paper-plane mr-2"></i>Delivery Location</h6>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.delivery_state.label.text }}</label>
                                                {{ form.delivery_state(class="form-control shadow-none", id="delivery_state") }}
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.delivery_city.label.text }}</label>
                                                {{ form.delivery_city(class="form-control shadow-none", id="delivery_city") }}
                                            </div>
                                            <div class="col-12">
                                                <label class="text-muted small font-weight-bold mb-1">{{ form.delivery_address.label.text }}</label>
                                                {{ form.delivery_address(class="form-control shadow-none", rows="2", placeholder="Street address...") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="bg-light p-4 rounded-lg mb-4">
                                <h5 class="text-dark font-weight-bold mb-3">Package Details</h5>
                                <div class="row align-items-end">
                                    <div class="col-md-7 mb-3 mb-md-0">
                                        <label class="text-muted small font-weight-bold mb-1">{{ form.package_weight.label.text }}</label>
                                        <div class="input-group">
                                            {{ form.package_weight(class="form-control border-right-0", id="package_weight", placeholder="Weight") }}
                                            <div class="input-group-append">
                                                <span class="input-group-text bg-white text-muted border-left-0">KG</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <button type="button" id="calculateBtn" class="btn btn-warning btn-block font-weight-bold shadow-sm py-2">
                                            <i class="fa fa-calculator mr-2"></i> Estimate Cost
                                        </button>
                                    </div>
                                </div>
                
                                <div class="alert alert-white border shadow-sm mt-4 mb-0 text-center d-none" id="estimateBox" style="border-radius: 12px; border-left: 5px solid #ffc107 !important;">
                                    <div class="row py-2">
                                        <div class="col border-right">
                                            <small class="text-muted d-block">Vehicle</small>
                                            <span id="estVehicle" class="h6 font-weight-bold mb-0 text-dark">-</span>
                                        </div>
                                        <div class="col border-right">
                                            <small class="text-muted d-block">Distance</small>
                                            <span class="h6 font-weight-bold mb-0 text-dark"><span id="estDistance">0</span> km</span>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted d-block">Cost</small>
                                            <span class="h6 font-weight-bold mb-0 text-primary">â‚¦<span id="estAmount">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            {{ form.distance_km(id="distance_km", type="hidden") }}
                            {{ form.calculated_amount(id="calculated_amount", type="hidden") }}
                
                            <button type="submit" class="btn btn-primary btn-lg btn-block shadow-lg py-3 font-weight-bold">
                                Complete Shipment Request
                            </button>
                        </form>
                        
                  
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{%endblock%}

{%block script%}
<script>
    $(document).ready(function() {

        function loadCities(stateSelectId, citySelectId) {
            const stateId = $(stateSelectId).val();
            const citySelect = $(citySelectId);
            
            citySelect.empty();
            
            if (stateId && stateId !== '0') {
                citySelect.append('<option value="0">Loading...</option>');
                
                // Corrected API endpoint URL using 'bpshipment'
                const apiUrl = "{{ url_for('bpshipment.get_cities', state_id=0) }}".replace('0', stateId);

                $.getJSON(apiUrl, function(data) {
                    citySelect.empty();
                    citySelect.append('<option value="">Select City</option>');
                    $.each(data, function(index, city) {
                        citySelect.append('<option value="' + city.id + '">' + city.name + '</option>');
                    });
                }).fail(function() {
                    citySelect.empty();
                    citySelect.append('<option value="">Error loading cities</option>');
                });
            } else {
                citySelect.empty();
                citySelect.append('<option value="">Select State First</option>');
            }
        }

        // Event handlers for state changes
        $('#pickup_state').change(function() {
            loadCities('#pickup_state', '#pickup_city');
        });

        $('#delivery_state').change(function() {
            loadCities('#delivery_state', '#delivery_city');
        });
        
        // --- Rate Calculation Placeholder Logic ---
    // --- Rate Calculation Logic (Must match server) ---


        // --- End Rate Calculation Logic ---
    });


    document.getElementById("calculateBtn").addEventListener("click", function () {
    const weight = parseFloat(document.getElementById("package_weight").value);
    const pickupState = document.getElementById("pickup_state").value;
    const deliveryState = document.getElementById("delivery_state").value;

    if (!weight || weight <= 0 || !pickupState || !deliveryState) {
        alert("Please fill weight and locations");
        return;
    }

    const distanceKm = pickupState === deliveryState ? 50 : 450;

    const VEHICLES = [
        { type: "bike", max: 15, base: 2000, perKg: 100, perKm: 30 },
        { type: "van", max: 500, base: 7000, perKg: 80, perKm: 80 },
        { type: "bus", max: 2000, base: 20000, perKg: 60, perKm: 150 }
    ];

    let selected;

    for (let v of VEHICLES) {
        if (weight <= v.max) {
            selected = v;
            break;
        }
    }

    if (!selected) {
        alert("Package too heavy. Contact support.");
        return;
    }

    const amount = selected.base + (weight * selected.perKg) + (distanceKm * selected.perKm);

    document.getElementById("estVehicle").innerText = selected.type.toUpperCase();
    document.getElementById("estAmount").innerText = amount.toLocaleString();
    document.getElementById("estDistance").innerText = distanceKm;

    document.getElementById("distance_km").value = distanceKm;
    document.getElementById("calculated_amount").value = amount.toFixed(2);

    document.getElementById("estimateBox").classList.remove("d-none");
});
</script>
{%endblock%}
   
